name: Gemini Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]

jobs:
  gemini-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr diff ${{ github.event.pull_request.number }} --repo ${{ github.repository }} > /tmp/pr_diff.txt
          DIFF_SIZE=$(wc -c < /tmp/pr_diff.txt)
          if [ "$DIFF_SIZE" -gt 100000 ]; then
            head -c 100000 /tmp/pr_diff.txt > /tmp/pr_diff_trimmed.txt
            mv /tmp/pr_diff_trimmed.txt /tmp/pr_diff.txt
            echo "trimmed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Review with Gemini 2.5 Pro
        id: review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          PR_BODY_SHORT=$(echo "$PR_BODY" | head -c 2000)
          DIFF=$(cat /tmp/pr_diff.txt)

          PROMPT="You are an expert code reviewer. Review the following pull request diff. Focus on: 1. Bugs and logic errors 2. Security vulnerabilities (injection, XSS, secrets in code) 3. Performance issues 4. TypeScript type safety 5. Missing error handling. Be concise. Only flag real issues. Use this format: ## Code Review Summary [1-2 sentence summary] ## Issues Found - **[severity]** file:line â€” description. Severity levels: Critical, Warning, Suggestion. If the code looks good, say so briefly."

          REQUEST_BODY=$(jq -n \
            --arg prompt "$PROMPT" \
            --arg title "$PR_TITLE" \
            --arg body "$PR_BODY_SHORT" \
            --arg diff "$DIFF" \
            '{
              "contents": [{
                "parts": [{"text": ($prompt + "\n\nPR: " + $title + "\n" + $body + "\n\nDiff:\n" + $diff)}]
              }],
              "generationConfig": {
                "temperature": 0.2,
                "maxOutputTokens": 4096
              }
            }')

          RESPONSE=$(curl -s -X POST \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent?key=${GEMINI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$REQUEST_BODY")

          REVIEW=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // "Review could not be generated."')

          echo "$REVIEW" > /tmp/review.md

      - name: Post review comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          REVIEW=$(cat /tmp/review.md)

          {
            echo "**Gemini 2.5 Pro Code Review**"
            echo ""
            echo "$REVIEW"
            echo ""
            echo "---"
            echo "*Automated review by Google Gemini 2.5 Pro*"
          } > /tmp/comment.md

          gh pr comment ${{ github.event.pull_request.number }} \
            --repo ${{ github.repository }} \
            --body-file /tmp/comment.md
